apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "airflow.fullname" . }}-scripts
  labels:
    app: {{ template "airflow.name" . }}
    chart: {{ template "airflow.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
data:
  install-requirements.sh: |
    #!/bin/sh -e
    if [ ! -d {{ .Values.dags.path }} ]; then
      echo "No folder {{ .Values.dags.path }}"
      exit 0
    fi
    cd {{ .Values.dags.path }}
    if [ -f requirements.txt ]; then
      pip install --user -r requirements.txt
    else
      exit 0
    fi
{{- if .Values.airflow.connections }}    
  add-connections.sh: |
    #!/bin/sh -e
    {{- range .Values.airflow.connections }}
    airflow connections --add --conn_type {{ .type }} --conn_id {{ .id }} 
    {{- if .uri }} --conn_uri {{ .uri | quote }} {{ end -}}
    {{- if .host }} --conn_host {{ .host }} {{ end -}}
    {{- if .login }} --conn_extra {{ .login }} {{ end -}}
    {{- if .password }} --conn_login {{ .password }} {{ end -}}
    {{- if .schema }} --conn_schema {{ .schema }} {{ end -}}
    {{- if .port }} --conn_port {{ .port }} {{ end -}}
    {{- if .extra }} --conn_extra {{ .extra | quote }} {{ end -}}
    {{- end }}
{{- end }}
