apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: {{ template "hydra.fullname" . }}
  labels:
    app: {{ template "hydra.name" . }}
    chart: {{ template "hydra.chart" . }}
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
spec:
  replicas: {{ .Values.hydra.replicas }}
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        checksum/secrets: {{ include (print $.Template.BasePath "/secrets.yaml") . | sha256sum }}
        checksum/adminproxy: {{ include (print $.Template.BasePath "/configmap-adminproxy.yaml") . | sha256sum }}
      labels:
        app: {{ template "hydra.name" . }}
        release: "{{ .Release.Name }}"
    spec:
      securityContext:
{{ toYaml .Values.hydra.securityContext | indent 8 }}
    {{- with .Values.hydra.image.pullSecrets }}
      imagePullSecrets:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- if .Values.hydra.initContainers }}
      initContainers:
{{ tpl .Values.hydra.initContainers . | indent 8 }}
    {{- end }}
      containers:
        - name: {{ .Chart.Name }}
          image: "{{ .Values.hydra.image.repository }}:{{ .Values.hydra.image.tag }}"
          imagePullPolicy: {{ .Values.hydra.image.pullPolicy }}
          command: ["/start-hydra.sh"]
          args:
          - serve
          - all
          {{- if .Values.hydra.dangerousForceHttp }}
          - --dangerous-force-http
          {{- end }}
          envFrom:
            - secretRef:
                name: {{ template "hydra.fullname" . }}
            - configMapRef:
                name: {{ template "hydra.fullname" . }}
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: {{ template "hydra.fullname" . }}-db
                  key: DATABASE_URL
{{- with .Values.hydra.extraEnv }}
{{ tpl . $ | indent 12 }}
{{- end }}
          volumeMounts:
          - name: hydra-startscript
            mountPath: /start-hydra.sh
            subPath: start-hydra.sh
{{- if .Values.hydra.adminProxy.enable }}
          - name: socket
            mountPath: /socket
{{- end }}
          {{- if .Values.hydra.extraVolumeMounts }}
{{ tpl .Values.hydra.extraVolumeMounts . | indent 12 }}
          {{- end }}
          ports:
            - name: public
              containerPort: 4444
              protocol: TCP
{{- if not .Values.hydra.adminProxy.enable }}
            - name: admin
              containerPort: 4445
              protocol: TCP
{{- end }}
          livenessProbe:
            httpGet:
              path: /health/alive
              port: public
            initialDelaySeconds: {{ .Values.hydra.livenessProbe.initialDelaySeconds }}
            timeoutSeconds: {{ .Values.hydra.livenessProbe.timeoutSeconds }}
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 4445
            initialDelaySeconds: {{ .Values.hydra.readinessProbe.initialDelaySeconds }}
            timeoutSeconds: {{ .Values.hydra.readinessProbe.timeoutSeconds }}
          resources:
{{ toYaml .Values.hydra.resources | indent 12 }}
{{- if .Values.hydra.adminProxy.enable }}
        - name: adminproxy
          image: "{{ .Values.hydra.adminProxy.image }}"
          ports:
            - name: admin
              containerPort: 4445
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /nginx/ready
              port: admin
          volumeMounts:
          - name: socket
            mountPath: /socket
          - name: nginx-config
            mountPath: /etc/nginx/conf.d/
            readOnly: true
          - name: nginx
            mountPath: /var/cache/nginx
          - name: nginx
            mountPath: /var/run
          resources:
{{ toYaml .Values.hydra.adminProxy.resources | indent 12 }}
{{- end }}
{{- with .Values.hydra.extraContainers }}
{{ tpl . $ | indent 8 }}
{{- end }}
    {{- with .Values.hydra.affinity }}
      affinity:
{{ tpl . $ | indent 8 }}
    {{- end }}
    {{- with .Values.hydra.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.hydra.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}
      terminationGracePeriodSeconds: 60
      volumes:
      - name: hydra-startscript
        configMap:
          name: {{ .Release.Name }}-start-script
          defaultMode: 0744
          items:
          - key : start-hydra.sh
            path: start-hydra.sh
{{- if .Values.hydra.adminProxy.enable }}
      - name: socket
        emptyDir: {}
      - name: nginx
        emptyDir: {}
      - name: nginx-config
        configMap:
          name: {{ .Release.Name }}-adminproxy
{{- end }}
{{ tpl .Values.hydra.extraVolumes . | indent 6 }}
