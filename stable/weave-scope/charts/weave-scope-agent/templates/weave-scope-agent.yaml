apiVersion: v1
kind: List
items:
  - metadata:
      labels:
        name: {{ .Values.serviceAccount | default "weave-scope" }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        app: {{ template "fullname" . }}
        heritage: {{ .Release.Service }}
        release: {{ .Release.Name }}
        {{- include "scope_labels" . | indent 8 }}
      name: {{ .Values.serviceAccount | default "weave-scope" }}
      annotations:
        {{- include "scope_annotations" . | indent 8 }}
    apiVersion: v1
    kind: ServiceAccount
  - metadata:
      labels:
        name: {{ .Values.serviceAccount | default "weave-scope" }}-agent
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        app: {{ template "fullname" . }}
        heritage: {{ .Release.Service }}
        release: {{ .Release.Name }}
        {{- include "scope_labels" . | indent 8 }}
      name: {{ template "fullname" . }}-agent
      annotations:
        {{- include "scope_annotations" . | indent 8 }}
    spec:
      selector: 
        matchLabels:
          name: {{ template "fullname" . }}-agent
          app: {{ template "fullname" . }}
          heritage: {{ .Release.Service }}
          release: {{ .Release.Name }}
      updateStrategy:
        type: RollingUpdate
      template:
        metadata:
          labels:
            name: {{ template "fullname" . }}-agent
            chart: {{ .Chart.Name }}-{{ .Chart.Version }}
            app: {{ template "fullname" . }}
            heritage: {{ .Release.Service }}
            release: {{ .Release.Name }}
            {{- include "scope_labels" . | indent 12 }}
        spec:
          tolerations:
            - effect: NoSchedule
              operator: Exists
          containers:
            - name: agent
              image: {{ .Values.global.image | default "weaveworks/scope" }}:{{ .Values.global.imageTag | default "1.6.1" }}
              imagePullPolicy: {{ .Values.imagePullPolicy | default "" | quote }}
              args:
                - '--no-app'
                - '--probe.docker.bridge={{ .Values.dockerBridge | default "docker0" }}'
                - '--probe.docker=true'
                - '--probe.kubernetes=true'
                {{- if .Values.probeToken }}
                - '--probe-token={{ .Values.probeToken }}'
                {{- else if .Values.scopeFrontendAddr }}
                - >-  {{ .Values.scopeFrontendAddr }}
                {{- else }}
                - >-
                  {{ .Values.global.serviceName | default "weave-scope-app" }}.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain | default "cluster.local" }}:{{ .Values.global.servicePort | default 80 }}
                {{- end }}
              securityContext:
                privileged: true
              {{- include "scope_resources" . | indent 14 }}
              volumeMounts:
                - name: docker-socket
                  mountPath: /var/run/docker.sock
                - name: scope-plugins
                  mountPath: /var/run/scope/plugins
          volumes:
            - name: docker-socket
              hostPath:
                path: /var/run/docker.sock
            - name: scope-plugins
              hostPath:
                path: /var/run/scope/plugins
          hostPID: true
          hostNetwork: true
          dnsPolicy: ClusterFirstWithHostNet
          serviceAccountName: {{ .Values.serviceAccount | default "weave-scope" }}
    apiVersion: extensions/v1beta1
    kind: DaemonSet
  - metadata:
      labels:
        name: weave-scope
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        app: {{ template "fullname" . }}
        heritage: {{ .Release.Service }}
        release: {{ .Release.Name }}
        {{- include "scope_labels" . | indent 8 }}
      name: weave-scope
      annotations:
        {{- include "scope_annotations" . | indent 8 }}
    rules:
      - apiGroups:
          - '*'
        resources:
          - '*'
        verbs:
          - '*'
      - nonResourceURLs:
          - '*'
        verbs:
          - '*'
    apiVersion: rbac.authorization.k8s.io/v1beta1
    kind: ClusterRole
  - metadata:
      labels:
        name: weave-scope
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        app: {{ template "fullname" . }}
        heritage: {{ .Release.Service }}
        release: {{ .Release.Name }}
        {{- include "scope_labels" . | indent 8 }}
      name: weave-scope
      annotations:
        {{- include "scope_annotations" . | indent 8 }}
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: weave-scope
    subjects:
      - kind: ServiceAccount
        name: {{ .Values.serviceAccount | default "weave-scope" }}
        namespace: {{ .Release.Namespace }}
    apiVersion: rbac.authorization.k8s.io/v1beta1
    kind: ClusterRoleBinding
