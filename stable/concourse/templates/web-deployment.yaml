apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: {{ template "concourse.web.fullname" . }}
  labels:
    app: {{ template "concourse.web.fullname" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
spec:
  replicas: {{ .Values.web.replicas }}
  template:
    metadata:
      labels:
        app: {{ template "concourse.web.fullname" . }}
        release: "{{ .Release.Name }}"
      annotations:
{{ toYaml .Values.web.annotations | indent 8 }}
    spec:
    {{- with .Values.web.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
      serviceAccountName: {{ if .Values.rbac.create }}{{ template "concourse.web.fullname" . }}{{ else }}{{ .Values.rbac.webServiceAccountName }}{{ end }}
      tolerations:
{{ toYaml .Values.web.tolerations | indent 8 }}
      containers:
        - name: {{ template "concourse.web.fullname" . }}
          image: "{{ .Values.image }}:{{ .Values.imageTag }}"
          imagePullPolicy: {{ .Values.imagePullPolicy | quote }}
          args:
            - "web"
          env:
            {{- if .Values.concourse.web.logLevel }}
            - name: CONCOURSE_LOG_LEVEL
              value: {{ .Values.concourse.web.logLevel | quote }}
            {{- end }}
            {{- if .Values.concourse.web.bindPort }}
            - name: CONCOURSE_BIND_PORT
              value: {{ .Values.concourse.web.bindPort | quote }}
            {{- end }}
            {{- if .Values.concourse.web.bindIp }}
            - name: CONCOURSE_BIND_IP
              value: {{ .Values.concourse.web.bindIp | quote }}
            {{- end }}
            {{- if .Values.concourse.web.localAuth.enabled }}
            - name: CONCOURSE_ADD_LOCAL_USER
              value: {{ .Values.secrets.localUsers }}
            {{- end }}
            {{- if .Values.concourse.web.tlsBindPort }}
            - name: CONCOURSE_TLS_BIND_PORT
              value: {{ .Values.concourse.web.tlsBindPort | quote }}
            {{- end }}
            {{- if .Values.concourse.web.tlsCert }}
            - name: CONCOURSE_TLS_CERT
              value: {{ .Values.concourse.web.tlsCert }}
            {{- end }}
            {{- if .Values.concourse.web.tlsKey }}
            - name: CONCOURSE_TLS_KEY
              value: {{ .Values.concourse.web.tlsKey }}
            {{- end }}
            {{- if .Values.concourse.web.externalUrl }}
            - name: CONCOURSE_EXTERNAL_URL
              value: {{ .Values.concourse.web.externalUrl | quote }}
            {{- end }}
            {{- if .Values.concourse.web.peerUrl }}
            - name: CONCOURSE_PEER_URL
              value: {{ .Values.concourse.web.peerUrl }}
            {{- else }}
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: CONCOURSE_PEER_URL
              value: "http://$(POD_IP):$(CONCOURSE_BIND_PORT)"
            {{- end }}
            {{- if .Values.concourse.web.encryption.enabled }}
            - name: CONCOURSE_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: encryption-key
            - name: CONCOURSE_OLD_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: old-encryption-key
            {{- end }}
            {{- if .Values.concourse.web.debugBindIp }}
            - name: CONCOURSE_DEBUG_BIND_IP
              value: {{ .Values.concourse.web.debugBindIp | quote }}
            {{- end }}
            {{- if .Values.concourse.web.debugBindPort }}
            - name: CONCOURSE_DEBUG_BIND_PORT
              value: {{ .Values.concourse.web.debugBindPort | quote }}
            {{- end }}
            {{- if .Values.web.interceptIdleTimeout }}
            - name: CONCOURSE_INTERCEPT_IDLE_TIMEOUT
              value: {{ .Values.web.interceptIdleTimeout | quote }}
            {{- end }}
            {{- if .Values.web.globalResourceCheckTimeout }}
            - name: CONCOURSE_GLOBAL_RESOURCE_CHECK_TIMEOUT
              value: {{ .Values.web.globalResourceCheckTimeout | quote }}
            {{- end }}
            {{- if .Values.web.resourceCheckingInterval }}
            - name: CONCOURSE_RESOURCE_CHECKING_INTERVAL
              value: {{ .Values.concourse.resourceCheckingInterval | quote }}
            {{- end }}
            {{- if .Values.web.resourceTypeCheckingInterval }}
            - name: CONCOURSE_RESOURCE_TYPE_CHECKING_INTERVAL
              value: {{ .Values.web.resourceTypeCheckingInterval }}
            {{- end }}
            {{- if .Values.concourse.web.containerPlacementStrategy }}
            - name: CONCOURSE_CONTAINER_PLACEMENT_STRATEGY
              value: {{ .Values.concourse.web.containerPlacementStrategy | quote }}
            {{- end }}
            {{- if .Values.concourse.web.baggageclaimResponseHeaderTimeout }}
            - name: CONCOURSE_BAGGAGECLAIM_RESPONSE_HEADER_TIMEOUT
              value: {{ .Values.concourse.web.baggageclaimResponseHeaderTimeout | quote }}
            {{- end }}
            {{- if .Values.concourse.web.cliArtifactsDir }}
            - name: CONCOURSE_CLI_ARTIFACTS_DIR
              value: {{ .Values.web.cliArtifactsDir }}
            {{- end }}
            {{- if .Values.concourse.web.logDbQueries }}
            - name: CONCOURSE_LOG_DB_QUERIES
              value: {{ .Values.concourse.web.logDbQueries }}
            {{- end }}
            {{- if .Values.concourse.web.buildTrackerInterval }}
            - name: CONCOURSE_BUILD_TRACKER_INTERVAL
              value: {{ .Values.concourse.web.buildTrackerInterval | quote  }}
            {{- end }}
            {{- if .Values.concourse.web.defaultBuildLogsToRetain }}
            - name: CONCOURSE_DEFAULT_BUILD_LOGS_TO_RETAIN
              value: {{ .Values.concourse.web.defaultBuildLogsToRetain | quote }}
            {{- end }}
            {{- if .Values.concourse.web.maxBuildLogsToRetain }}
            - name: CONCOURSE_MAX_BUILD_LOGS_TO_RETAIN
              value: {{ .Values.concourse.web.maxBuildLogsToRetain | quote }}
            {{- end }}
            {{- if .Values.concourse.web.defaultTaskCpuLimit }}
            - name: CONCOURSE_DEFAULT_TASK_CPU_LIMIT
              value: {{ .Values.concourse.web.defaultTaskCpuLimit | quote }}
            {{- end }}
            {{- if .Values.concourse.web.defaultTaskMemoryLimit }}
            - name: CONCOURSE_DEFAULT_TASK_MEMORY_LIMIT
              value: {{ .Values.concourse.web.defaultTaskMemoryLimit }}
            {{- end }}

            {{- if .Values.postgresql.enabled }}
            - name: CONCOURSE_POSTGRES_HOST
              value: {{ template "concourse.postgresql.fullname" . }}
            - name: CONCOURSE_POSTGRES_USER
              value: {{ .Values.postgresql.postgresUser }}
            - name: CONCOURSE_POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.postgresql.fullname" . }}
                  key: postgres-password
            - name: CONCOURSE_POSTGRES_DATABASE
              value: {{ .Values.postgresql.postgresDatabase | quote }}
            {{- else }}
            {{- if .Values.concourse.web.postgres.host }}
            - name: CONCOURSE_POSTGRES_HOST
              value: {{ .Values.concourse.web.postgres.host }}
            {{- end }}
            {{- if .Values.concourse.web.postgres.port }}
            - name: CONCOURSE_POSTGRES_PORT
              value: {{ .Values.concourse.web.postgres.port | quote }}
            {{- end }}
            {{- if .Values.concourse.web.postgres.socket }}
            - name: CONCOURSE_POSTGRES_SOCKET
              value: {{ .Values.concourse.web.postgres.socket }}
            {{- end }}
            - name: CONCOURSE_POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: postgresql-user
            - name: CONCOURSE_POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: postgresql-password
            {{- if .Values.concourse.web.postgres.sslmode }}
            - name: CONCOURSE_POSTGRES_SSLMODE
              value: {{ .Values.concourse.web.postgres.sslmode }}
            {{- end }}
            {{- if not (eq (default "disable" .Values.concourse.web.postgres.sslmode) "disable") }}
            - name: CONCOURSE_POSTGRES_CA_CERT
              value: "/concourse-postgresql/ca.cert"
            {{- if eq .Values.concourse.web.postgres.sslmode "required" }}
            - name: CONCOURSE_POSTGRES_CLIENT_CERT
              value: "/concourse-postgresql/client.cert"
            - name: CONCOURSE_POSTGRES_CLIENT_KEY
              value: "/concourse-postgresql/client.key"
            {{- end }}
            {{- end }}
            {{- if .Values.concourse.web.postgres.connectTimeout }}
            - name: CONCOURSE_POSTGRES_CONNECT_TIMEOUT
              value: {{ .Values.concourse.web.postgres.connectTimeout }}
            {{- end }}
            {{- if .Values.concourse.web.postgres.database }}
            - name: CONCOURSE_POSTGRES_DATABASE
              value: {{ .Values.concourse.web.postgres.database }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.kubernetes.enabled }}
            - name: CONCOURSE_KUBERNETES_IN_CLUSTER
              value: "true"
            - name: CONCOURSE_KUBERNETES_NAMESPACE_PREFIX
              value: {{ template "concourse.namespacePrefix" . }}
            {{- else}}
            {{- if .Values.concourse.web.kubernetes.configPath }}
            - name: CONCOURSE_KUBERNETES_CONFIG_PATH
              value: {{ .Values.concourse.web.kubernetes.configPath }}
            {{- end }}
            {{- if .Values.concourse.web.kubernetes.namespacePrefix }}
            - name: CONCOURSE_KUBERNETES_NAMESPACE_PREFIX
              value: {{ .Values.concourse.web.kubernetes.namespacePrefix }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.awsSecretsManager.enabled }}
            - name: CONCOURSE_AWS_SECRETSMANAGER_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: aws-secretsmanager-access-key
            - name: CONCOURSE_AWS_SECRETSMANAGER_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: aws-secretsmanager-secret-key
            {{- if .Values.secrets.awsSsmSessionToken }}
            - name: CONCOURSE_AWS_SECRETSMANAGER_SESSION_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: aws-secretsmanager-session-token
            {{- end }}
            {{- if .Values.concoures.web.awsSecretsManager.region }}
            - name: AWS_REGION
              value: {{ .Values.concoures.web.awsSecretsManager.region }}
            {{- end }}
            {{- if .Values.concoures.web.awsSecretsManager.pipelineSecretTemplate }}
            - name: CONCOURSE_AWS_SECRETSMANAGER_PIPELINE_SECRET_TEMPLATE
              value: {{ .Values.concoures.web.awsSecretsManager.pipelineSecretTemplate | quote }}
            {{- end }}
            {{- if .Values.concourse.web.awsSecretsManager.teamSecretTemplate }}
            - name: CONCOURSE_AWS_SECRETSMANAGER_TEAM_SECRET_TEMPLATE
              value: {{ .Values.concourse.web.awsSecretsManager.teamSecretTemplate | quote }}
            {{- end }}
            {{- end }}


            {{- if .Values.concourse.web.awsSsm.enabled }}
            - name: CONCOURSE_AWS_SSM_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: aws-ssm-access-key
            - name: CONCOURSE_AWS_SSM_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: aws-ssm-secret-key
            {{- if .Values.secrets.awsSsmSessionToken }}
            - name: CONCOURSE_AWS_SSM_SESSION_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: aws-ssm-session-token
            {{- end }}
            {{- if .Values.concoures.web.awsSsm.region }}
            - name: AWS_REGION
              value: {{ .Values.concoures.web.awsSsm.region }}
            {{- end }}
            {{- if .Values.credentialManager.awsSsm.pipelineSecretTemplate }}
            - name: CONCOURSE_AWS_SSM_PIPELINE_SECRET_TEMPLATE
              value: {{ .Values.credentialManager.awsSsm.pipelineSecretTemplate | quote }}
            {{- end }}
            {{- if .Values.credentialManager.awsSsm.teamSecretTemplate }}
            - name: CONCOURSE_AWS_SSM_TEAM_SECRET_TEMPLATE
              value: {{ .Values.credentialManager.awsSsm.teamSecretTemplate | quote }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.vault.enabled }}
            - name: CONCOURSE_VAULT_URL
              value: {{ .Values.concourse.web.vault.url | quote }}
            - name: CONCOURSE_VAULT_PATH_PREFIX
              value: {{ .Values.concourse.web.vault.pathPrefix | quote }}
            - name: CONCOURSE_VAULT_AUTH_BACKEND
              value: {{ .Values.concourse.web.vault.authBackend | quote }}
            - name: CONCOURSE_VAULT_CLIENT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: vault-client-token
            {{- if .Values.concourse.web.vault.useCaCert }}
            - name: CONCOURSE_VAULT_CA_CERT
              value: "/concourse-vault/ca.cert"
            {{- end }}
            {{- if eq (default "" .Values.concourse.web.vault.authBackend) "cert" }}
            - name: CONCOURSE_VAULT_CLIENT_CERT
              value: "/concourse-vault/client.cert"
            - name: CONCOURSE_VAULT_CLIENT_KEY
              value: "/concourse-vault/client.key"
            {{- end }}
            {{- if .Values.concourse.web.vault.authBackendMaxTtl }}
            - name: CONCOURSE_VAULT_AUTH_BACKEND_MAX_TTL
              value: {{ .Values.concourse.web.vault.authBackendMaxTtl }}
            {{- end }}
            {{- if .Values.concourse.web.vault.authParam }}
            - name: CONCOURSE_VAULT_AUTH_PARAM
              value: {{ .Values.concourse.web.vault.authParam | quote }}
            {{- end }}
            {{- if .Values.concourse.web.vault.cache }}
            - name: CONCOURSE_VAULT_CACHE
              value: {{ .Values.concourse.web.vault.cache }}
            {{- end }}
            {{- if .Values.concourse.web.vault.caPath }}
            - name: CONCOURSE_VAULT_CA_PATH
              value: {{ .Values.concourse.web.vault.caPath }}
            {{- end }}
            {{- if .Values.concourse.web.vault.insecureSkipVerify }}
            - name: CONCOURSE_VAULT_INSECURE_SKIP_VERIFY
              value: {{ .Values.concourse.web.vault.insecureSkipVerify }}
            {{- end }}
            {{- if .Values.concourse.web.vault.maxLease }}
            - name: CONCOURSE_VAULT_MAX_LEASE
              value: {{ .Values.concourse.web.vault.maxLease }}
            {{- end }}
            {{- if .Values.concourse.web.vault.retryInitial }}
            - name: CONCOURSE_VAULT_RETRY_INITIAL
              value: {{ .Values.concourse.web.vault.retryInitial }}
            {{- end }}
            {{- if .Values.concourse.web.vault.retryMax }}
            - name: CONCOURSE_VAULT_RETRY_MAX
              value: {{ .Values.concourse.web.vault.retryMax }}
            {{- end }}
            {{- if .Values.concourse.web.vault.serverName }}
            - name: CONCOURSE_VAULT_SERVER_NAME
              value: {{ .Values.concourse.web.vault.serverName }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.noop }}
            - name: CONCOURSE_NOOP
              value: {{ .Values.concourse.web.noop }}
            {{- end }}

            {{- if .Values.concourse.web.staticWorker.enabled }}
            {{- if .Values.concourse.web.staticWorker.gardenUrl }}
            - name: CONCOURSE_WORKER_GARDEN_URL
              value: {{ .Values.concourse.web.staticWorker.gardenUrl }}
            {{- end }}
            {{- if .Values.concourse.web.staticWorker.baggageclaimUrl }}
            - name: CONCOURSE_WORKER_BAGGAGECLAIM_URL
              value: {{ .Values.concourse.web.staticWorker.baggageclaimUrl }}
            {{- end }}
            {{- if .Values.concourse.web.staticWorker.resource }}
            - name: CONCOURSE_WORKER_RESOURCE
              value: {{ .Values.concourse.web.staticWorker.resource | quote }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.metrics.hostName }}
            - name: CONCOURSE_METRICS_HOST_NAME
              value: {{ .Values.concourse.web.metrics.hostName }}
            {{- end }}
            {{- if .Values.concourse.web.metrics.attribute }}
            - name: CONCOURSE_METRICS_ATTRIBUTE
              value: {{ .Values.concourse.web.metrics.attribute | quote }}
            {{- end }}

            {{- if .Values.concourse.web.datadog.enabled }}
            - name: CONCOURSE_DATADOG_AGENT_HOST
            {{- if .Values.concourse.web.datadog.agentHostUseHostIP }}
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            {{- else }}
              value: {{ .Values.concourse.web.datadog.agentHost | quote }}
            {{- end }}
            - name: CONCOURSE_DATADOG_AGENT_PORT
              value: {{ .Values.concourse.web.datadog.agentPort | quote }}
            {{- if .Values.concourse.web.datadog.prefix }}
            - name: CONCOURSE_DATADOG_PREFIX
              value: {{ .Values.concourse.web.datadog.prefix }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.influxdb.enabled }}
            - name: CONCOURSE_INFLUXDB_URL
              value: {{ .Values.concourse.web.influxdb.url | quote }}
            - name: CONCOURSE_INFLUXDB_DATABASE
              value: {{ .Values.concourse.web.influxdb.database | quote }}
            - name: CONCOURSE_INFLUXDB_USERNAME
              value: {{ .Values.concourse.web.influxdb.username | quote }}
            - name: CONCOURSE_INFLUXDB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: influxdb-password
            - name: CONCOURSE_INFLUXDB_INSECURE_SKIP_VERIFY
              value: {{ .Values.concourse.web.influxdb.insecureSkipVerify | quote}}
            {{- end }}

            {{- if .Values.concourse.web.emitToLogs }}
            - name: CONCOURSE_EMIT_TO_LOGS
              value: {{ .Values.concourse.web.emitToLogs }}
            {{- end }}

            {{- if .Values.concourse.web.newrelic.enabled }}
            {{- if .Values.concourse.web.newrelic.accountId }}
            - name: CONCOURSE_NEWRELIC_ACCOUNT_ID
              value: {{ .Values.concourse.web.newrelic.accountId }}
            {{- end }}
            {{- if .Values.concourse.web.newrelic.apiKey }}
            - name: CONCOURSE_NEWRELIC_API_KEY
              value: {{ .Values.concourse.web.newrelic.apiKey }}
            {{- end }}
            {{- if .Values.concourse.web.newrelic.servicePrefix }}
            - name: CONCOURSE_NEWRELIC_SERVICE_PREFIX
              value: {{ .Values.concourse.web.newrelic.servicePrefix }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.prometheus.enabled }}
            - name: CONCOURSE_PROMETHEUS_BIND_IP
              value: {{ .Values.concourse.web.prometheus.bindIp | quote }}
            - name: CONCOURSE_PROMETHEUS_BIND_PORT
              value: {{ .Values.concourse.web.prometheus.bindPort | quote }}
            {{- end }}

            {{- if .Values.concourse.web.riemann.enabled }}
            {{- if .Values.concourse.web.riemann.host }}
            - name: CONCOURSE_RIEMANN_HOST
              value: {{ .Values.concourse.web.riemann.host }}
            {{- end }}
            {{- if .Values.concourse.web.riemann.port }}
            - name: CONCOURSE_RIEMANN_PORT
              value: {{ .Values.concourse.web.riemann.port | quote }}
            {{- end }}
            {{- if .Values.concourse.web.riemann.servicePrefix }}
            - name: CONCOURSE_RIEMANN_SERVICE_PREFIX
              value: {{ .Values.concourse.web.riemann.servicePrefix }}
            {{- end }}
            {{- if .Values.concourse.web.riemann.tag }}
            - name: CONCOURSE_RIEMANN_TAG
              value: {{ .Values.concourse.web.riemann.tag }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.xFrameOptions }}
            - name: CONCOURSE_X_FRAME_OPTIONS
              value: {{ .Values.concourse.web.xFrameOptions }}
            {{- end }}

            {{- if .Values.concourse.web.gc.overrideDefaults }}
            {{- if .Values.concourse.web.gc.interval }}
            - name: CONCOURSE_GC_INTERVAL
              value: {{ .Values.concourse.web.gc.interval }}
            {{- end }}
            {{- if .Values.concourse.web.gc.oneOffGracePeriod }}
            - name: CONCOURSE_GC_ONE_OFF_GRACE_PERIOD
              value: {{ .Values.concourse.web.gc.oneOffGracePeriod }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.syslog.enabled }}
            {{- if .Values.concourse.web.syslog.hostname }}
            - name: CONCOURSE_SYSLOG_HOSTNAME
              value: {{ .Values.concourse.web.syslog.hostname }}
            {{- end }}
            {{- if .Values.concourse.web.syslog.address }}
            - name: CONCOURSE_SYSLOG_ADDRESS
              value: {{ .Values.concourse.web.syslog.address }}
            {{- end }}
            {{- if .Values.concourse.web.syslog.transport }}
            - name: CONCOURSE_SYSLOG_TRANSPORT
              value: {{ .Values.concourse.web.syslog.transport }}
            {{- end }}
            {{- if .Values.concourse.web.syslog.drainInterval }}
            - name: CONCOURSE_SYSLOG_DRAIN_INTERVAL
              value: {{ .Values.concourse.web.syslog.drainInterval }}
            {{- end }}
            {{- if .Values.concourse.web.syslog.useCaCert }}
            - name: CONCOURSE_SYSLOG_CA_CERT
              value: "/concourse-syslog/ca.cert"
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.auth.cookieSecure }}
            - name: CONCOURSE_COOKIE_SECURE
              value: {{ .Values.concourse.web.auth.cookieSecure }}
            {{- end }}
            {{- if .Values.concourse.web.auth.duration }}
            - name: CONCOURSE_AUTH_DURATION
              value: {{ .Values.concourse.web.auth.duration | quote }}
            {{- end }}
            - name: CONCOURSE_SESSION_SIGNING_KEY
              value: "/concourse-keys/session_signing_key"

            {{- if .Values.concourse.web.auth.mainTeam.localUser }}
            - name: CONCOURSE_MAIN_TEAM_LOCAL_USER
              value: {{ .Values.concourse.web.auth.mainTeam.localUser | quote }}
            {{- end }}
            {{- if .Values.concourse.web.auth.mainTeam.allowAllUsers }}
            - name: CONCOURSE_MAIN_TEAM_ALLOW_ALL_USERS
              value: {{ .Values.concourse.web.auth.mainTeam.allowAllUsers }}
            {{- end }}

            {{- if .Values.concourse.web.auth.mainTeam.cf.org }}
            - name: CONCOURSE_MAIN_TEAM_CF_ORG
              value: {{ .Values.concourse.web.auth.mainTeam.cf.org | quote }}
            {{- end }}
            {{- if .Values.concourse.web.auth.mainTeam.cf.space }}
            - name: CONCOURSE_MAIN_TEAM_CF_SPACE
              value: {{ .Values.concourse.web.auth.mainTeam.cf.space | quote }}
            {{- end }}
            {{- if .Values.concourse.web.auth.mainTeam.cf.spaceGuid }}
            - name: CONCOURSE_MAIN_TEAM_CF_SPACE_GUID
              value: {{ .Values.concourse.web.auth.mainTeam.cf.spaceGuid | quote }}
            {{- end }}
            {{- if .Values.concourse.web.auth.mainTeam.cf.user }}
            - name: CONCOURSE_MAIN_TEAM_CF_USER
              value: {{ .Values.concourse.web.auth.mainTeam.cf.user | quote }}
            {{- end }}

            {{- if .Values.concourse.web.auth.mainTeam.github.user }}
            - name: CONCOURSE_MAIN_TEAM_GITHUB_USER
              value: {{ .Values.concourse.web.auth.mainTeam.github.user | quote }}
            {{- end }}
            {{- if .Values.concourse.web.auth.mainTeam.github.org }}
            - name: CONCOURSE_MAIN_TEAM_GITHUB_ORG
              value: {{ .Values.concourse.web.auth.mainTeam.github.org | quote }}
            {{- end }}
            {{- if .Values.concourse.web.auth.mainTeam.github.team }}
            - name: CONCOURSE_MAIN_TEAM_GITHUB_TEAM
              value: {{ .Values.concourse.web.auth.mainTeam.github.team | quote }}
            {{- end }}

            {{- if .Values.concourse.web.auth.mainTeam.gitlab.user }}
            - name: CONCOURSE_MAIN_TEAM_GITLAB_USER
              value: {{ .Values.concourse.web.auth.mainTeam.gitlab.user | quote }}
            {{- end }}
            {{- if .Values.concourse.web.auth.mainTeam.gitlab.group }}
            - name: CONCOURSE_MAIN_TEAM_GITLAB_GROUP
              value: {{ .Values.concourse.web.auth.mainTeam.gitlab.group | quote }}
            {{- end }}

            {{- if .Values.concourse.web.auth.mainTeam.ldap.user }}
            - name: CONCOURSE_MAIN_TEAM_LDAP_USER
              value: {{ .Values.concourse.web.auth.mainTeam.ldap.user | quote }}
            {{- end }}
            {{- if .Values.concourse.web.auth.mainTeam.ldap.group }}
            - name: CONCOURSE_MAIN_TEAM_LDAP_GROUP
              value: {{ .Values.concourse.web.auth.mainTeam.ldap.group | quote }}
            {{- end }}

            {{- if .Values.concourse.web.auth.mainTeam.oauth.user }}
            - name: CONCOURSE_MAIN_TEAM_OAUTH_USER
              value: {{ .Values.concourse.web.auth.mainTeam.oauth.user | quote }}
            {{- end }}
            {{- if .Values.concourse.web.auth.mainTeam.oauth.group }}
            - name: CONCOURSE_MAIN_TEAM_OAUTH_GROUP
              value: {{ .Values.concourse.web.auth.mainTeam.oauth.group | quote }}
            {{- end }}

            {{- if .Values.concourse.web.auth.mainTeam.oidc.group }}
            - name: CONCOURSE_MAIN_TEAM_OIDC_GROUP
              value: {{ .Values.concourse.web.auth.mainTeam.oidc.group | quote }}
            {{- end }}
            {{- if .Values.concourse.web.auth.mainTeam.oidc.user }}
            - name: CONCOURSE_MAIN_TEAM_OIDC_USER
              value: {{ .Values.concourse.web.auth.mainTeam.oidc.user | quote }}
            {{- end }}

            {{- if .Values.concourse.web.auth.cf.enabled }}
            - name: CONCOURSE_CF_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: cf-client-id
            - name: CONCOURSE_CF_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: cf-client-secret
            {{- if .Values.concourse.web.auth.cf.apiUrl }}
            - name: CONCOURSE_CF_API_URL
              value: {{ .Values.concourse.web.auth.cf.apiUrl }}
            {{- end }}
            {{- if .Values.concourse.web.auth.cf.useCaCert }}
            - name: CONCOURSE_CF_CA_CERT
              value: "/concourse-auth/cf_ca.cert"
            {{- end }}
            {{- if .Values.concourse.web.auth.cf.skipSslValidation }}
            - name: CONCOURSE_CF_SKIP_SSL_VALIDATION
              value: {{ .Values.concourse.web.auth.cf.skipSslValidation }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.auth.github.enabled }}
            - name: CONCOURSE_GITHUB_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: github-client-id
            - name: CONCOURSE_GITHUB_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: github-client-secret
            {{- if .Values.concourse.web.auth.github.host }}
            - name: CONCOURSE_GITHUB_HOST
              value: {{ .Values.concourse.web.auth.github.host }}
            {{- end }}
            {{- if .Values.concourse.web.auth.github.useCaCert }}
            - name: CONCOURSE_GITHUB_CA_CERT
              value: "/concourse-auth/github_ca.cert"
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.auth.gitlab.enabled }}
            - name: CONCOURSE_GITLAB_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: gitlab-client-id
            - name: CONCOURSE_GITLAB_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: gitlab-client-secret
            {{- if .Values.concourse.web.auth.gitlab.host }}
            - name: CONCOURSE_GITLAB_HOST
              value: {{ .Values.concourse.web.auth.gitlab.host }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.auth.ldap.enabled }}
            {{- if .Values.concourse.web.auth.ldap.bindDn }}
            - name: CONCOURSE_LDAP_BIND_DN
              value: {{ .Values.concourse.web.auth.ldap.bindDn }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.bindPw }}
            - name: CONCOURSE_LDAP_BIND_PW
              value: {{ .Values.concourse.web.auth.ldap.bindPw }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.useCaCert }}
            - name: CONCOURSE_LDAP_CA_CERT
              value: "/concourse-auth/ldap_ca.cert"
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.displayName }}
            - name: CONCOURSE_LDAP_DISPLAY_NAME
              value: {{ .Values.concourse.web.auth.ldap.displayName }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.groupSearchBaseDn }}
            - name: CONCOURSE_LDAP_GROUP_SEARCH_BASE_DN
              value: {{ .Values.concourse.web.auth.ldap.groupSearchBaseDn }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.groupSearchFilter }}
            - name: CONCOURSE_LDAP_GROUP_SEARCH_FILTER
              value: {{ .Values.concourse.web.auth.ldap.groupSearchFilter }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.groupSearchGroupAttr }}
            - name: CONCOURSE_LDAP_GROUP_SEARCH_GROUP_ATTR
              value: {{ .Values.concourse.web.auth.ldap.groupSearchGroupAttr }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.groupSearchNameAttr }}
            - name: CONCOURSE_LDAP_GROUP_SEARCH_NAME_ATTR
              value: {{ .Values.concourse.web.auth.ldap.groupSearchNameAttr }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.groupSearchScope }}
            - name: CONCOURSE_LDAP_GROUP_SEARCH_SCOPE
              value: {{ .Values.concourse.web.auth.ldap.groupSearchScope }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.groupSearchUserAttr }}
            - name: CONCOURSE_LDAP_GROUP_SEARCH_USER_ATTR
              value: {{ .Values.concourse.web.auth.ldap.groupSearchUserAttr }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.host }}
            - name: CONCOURSE_LDAP_HOST
              value: {{ .Values.concourse.web.auth.ldap.host }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.insecureNoSsl }}
            - name: CONCOURSE_LDAP_INSECURE_NO_SSL
              value: {{ .Values.concourse.web.auth.ldap.insecureNoSsl }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.insecureSkipVerify }}
            - name: CONCOURSE_LDAP_INSECURE_SKIP_VERIFY
              value: {{ .Values.concourse.web.auth.ldap.insecureSkipVerify }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.startTls }}
            - name: CONCOURSE_LDAP_START_TLS
              value: {{ .Values.concourse.web.auth.ldap.startTls }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.userSearchBaseDn }}
            - name: CONCOURSE_LDAP_USER_SEARCH_BASE_DN
              value: {{ .Values.concourse.web.auth.ldap.userSearchBaseDn }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.userSearchEmailAttr }}
            - name: CONCOURSE_LDAP_USER_SEARCH_EMAIL_ATTR
              value: {{ .Values.concourse.web.auth.ldap.userSearchEmailAttr }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.userSearchFilter }}
            - name: CONCOURSE_LDAP_USER_SEARCH_FILTER
              value: {{ .Values.concourse.web.auth.ldap.userSearchFilter }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.userSearchIdAttr }}
            - name: CONCOURSE_LDAP_USER_SEARCH_ID_ATTR
              value: {{ .Values.concourse.web.auth.ldap.userSearchIdAttr }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.userSearchNameAttr }}
            - name: CONCOURSE_LDAP_USER_SEARCH_NAME_ATTR
              value: {{ .Values.concourse.web.auth.ldap.userSearchNameAttr }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.userSearchScope }}
            - name: CONCOURSE_LDAP_USER_SEARCH_SCOPE
              value: {{ .Values.concourse.web.auth.ldap.userSearchScope }}
            {{- end }}
            {{- if .Values.concourse.web.auth.ldap.userSearchUsername }}
            - name: CONCOURSE_LDAP_USER_SEARCH_USERNAME
              value: {{ .Values.concourse.web.auth.ldap.userSearchUsername }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.auth.oauth.enabled }}
            {{- if .Values.concourse.web.auth.oauth.displayName }}
            - name: CONCOURSE_OAUTH_DISPLAY_NAME
              value: {{ .Values.concourse.web.auth.oauth.displayName }}
            {{- end }}
            - name: CONCOURSE_OAUTH_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: oauth-client-id
            - name: CONCOURSE_OAUTH_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: oauth-client-secret
            {{- if .Values.concourse.web.auth.oauth.authUrl }}
            - name: CONCOURSE_OAUTH_AUTH_URL
              value: {{ .Values.concourse.web.auth.oauth.authUrl }}
            {{- end }}
            {{- if .Values.concourse.web.auth.oauth.tokenUrl }}
            - name: CONCOURSE_OAUTH_TOKEN_URL
              value: {{ .Values.concourse.web.auth.oauth.tokenUrl }}
            {{- end }}
            {{- if .Values.concourse.web.auth.oauth.userinfoUrl }}
            - name: CONCOURSE_OAUTH_USERINFO_URL
              value: {{ .Values.concourse.web.auth.oauth.userinfoUrl }}
            {{- end }}
            {{- if .Values.concourse.web.auth.oauth.scope }}
            - name: CONCOURSE_OAUTH_SCOPE
              value: {{ .Values.concourse.web.auth.oauth.scope }}
            {{- end }}
            {{- if .Values.concourse.web.auth.oauth.groupsKey }}
            - name: CONCOURSE_OAUTH_GROUPS_KEY
              value: {{ .Values.concourse.web.auth.oauth.groupsKey }}
            {{- end }}
            {{- if .Values.concourse.web.auth.oauth.useCaCert }}
            - name: CONCOURSE_OAUTH_CA_CERT
              value: "/concourse-auth/oauth_ca.cert"
            {{- end }}
            {{- if .Values.concourse.web.auth.oauth.skipSslValidation }}
            - name: CONCOURSE_OAUTH_SKIP_SSL_VALIDATION
              value: {{ .Values.concourse.web.auth.oauth.skipSslValidation }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.auth.oidc.enabled }}
            {{- if .Values.concourse.web.auth.oidc.displayName }}
            - name: CONCOURSE_OIDC_DISPLAY_NAME
              value: {{ .Values.concourse.web.auth.oidc.displayName }}
            {{- end }}
            {{- if .Values.concourse.web.auth.oidc.issuer }}
            - name: CONCOURSE_OIDC_ISSUER
              value: {{ .Values.concourse.web.auth.oidc.issuer }}
            {{- end }}
            - name: CONCOURSE_OIDC_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: oidc-client-id
            - name: CONCOURSE_OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ template "concourse.concourse.fullname" . }}
                  key: oidc-client-secret
            {{- if .Values.concourse.web.auth.oidc.scope }}
            - name: CONCOURSE_OIDC_SCOPE
              value: {{ .Values.concourse.web.auth.oidc.scope }}
            {{- end }}
            {{- if .Values.concourse.web.auth.oidc.groupsKey }}
            - name: CONCOURSE_OIDC_GROUPS_KEY
              value: {{ .Values.concourse.web.auth.oidc.groupsKey }}
            {{- end }}
            {{- if .Values.concourse.web.auth.oidc.hostedDomains }}
            - name: CONCOURSE_OIDC_HOSTED_DOMAINS
              value: {{ .Values.concourse.web.auth.oidc.hostedDomains | quote }}
            {{- end }}
            {{- if .Values.concourse.web.auth.oidc.useCaCert }}
            - name: CONCOURSE_OIDC_CA_CERT
              value: "/concourse-auth/oidc_ca.cert"
            {{- end }}
            {{- if .Values.concourse.web.auth.oidc.skipSslValidation }}
            - name: CONCOURSE_OIDC_SKIP_SSL_VALIDATION
              value: {{ .Values.concourse.web.auth.oidc.skipSslValidation }}
            {{- end }}
            {{- end }}

            {{- if .Values.concourse.web.tsa.logLevel }}
            - name: CONCOURSE_TSA_LOG_LEVEL
              value: {{ .Values.concourse.web.tsa.logLevel }}
            {{- end }}
            {{- if .Values.concourse.web.tsa.bindIp }}
            - name: CONCOURSE_TSA_BIND_IP
              value: {{ .Values.concourse.web.tsa.bindIp }}
            {{- end }}
            - name: CONCOURSE_TSA_BIND_PORT
              value: {{ .Values.concourse.web.tsa.bindPort | quote }}
            {{- if .Values.concourse.web.tsa.bindDebugPort }}
            - name: CONCOURSE_TSA_BIND_DEBUG_PORT
              value: {{ .Values.concourse.web.tsa.bindDebugPort | quote }}
            {{- end }}
            {{- if .Values.concourse.web.tsa.peerIp }}
            - name: CONCOURSE_TSA_PEER_IP
              value: {{ .Values.concourse.web.tsa.peerIp }}
            {{- end }}
            - name: CONCOURSE_TSA_HOST_KEY
              value: "/concourse-keys/host_key"
            - name: CONCOURSE_TSA_AUTHORIZED_KEYS
              value: "/concourse-keys/worker_key.pub"
            {{- if .Values.concourse.web.tsa.teamAuthorizedKeys }}
            - name: CONCOURSE_TSA_TEAM_AUTHORIZED_KEYS
              value: {{ .Values.concourse.web.tsa.teamAuthorizedKeys }}
            {{- end }}
            {{- if .Values.concourse.web.tsa.atcUrl }}
            - name: CONCOURSE_TSA_ATC_URL
              value: {{ .Values.concourse.web.tsa.atcUrl }}
            {{- end }}
            {{- if .Values.concourse.web.tsa.sessionSigningKey }}
            - name: CONCOURSE_TSA_SESSION_SIGNING_KEY
              value: {{ .Values.concourse.web.tsa.sessionSigningKey }}
            {{- end }}
            {{- if .Values.concourse.web.tsa.heartbeatInterval }}
            - name: CONCOURSE_TSA_HEARTBEAT_INTERVAL
              value: {{ .Values.concourse.web.tsa.heartbeatInterval }}
            {{- end }}
{{- if .Values.web.env }}
{{ toYaml .Values.web.env | indent 12 }}
{{- end }}
          ports:
            - name: atc
              containerPort: {{ .Values.concourse.web.bindPort }}
            - name: tsa
              containerPort: {{ .Values.concourse.web.tsa.bindPort }}
            {{- if .Values.concourse.web.debugBindPort }}
            - name: atc-debug
              containerPort: {{ .Values.concourse.web.debugBindPort }}
            {{- end }}
            {{- if .Values.concourse.web.tsa.bindDebugPort }}
            - name: tsa-debug
              containerPort: {{ .Values.concourse.web.tsa.bindDebugPort }}
            {{- end }}
            {{- if .Values.concourse.web.prometheus.enabled }}
            - name: prometheus
              containerPort: {{ .Values.concourse.web.prometheus.bindPort }}
            {{- end }}
          livenessProbe:
            httpGet:
              path: /
              port: atc
            initialDelaySeconds: 120
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: atc
            initialDelaySeconds: 5
            timeoutSeconds: 1
          resources:
{{ toYaml .Values.web.resources | indent 12 }}
          volumeMounts:
            - name: concourse-keys
              mountPath: /concourse-keys
              readOnly: true
            {{- if .Values.concourse.web.vault.enabled }}
            - name: vault-keys
              mountPath: /concourse-vault
              readOnly: true
            {{- end }}
            {{- if not (eq (default "disable" .Values.concourse.web.postgres.sslmode) "disable") }}
            - name: postgresql-keys
              mountPath: /concourse-postgresql
              readOnly: true
            {{- end }}
            {{- if .Values.concourse.web.syslog.enabled }}
            - name: syslog-keys
              mountPath: /concourse-syslog
              readOnly: true
            {{- end }}
            - name: auth-keys
              mountPath: /concourse-auth
              readOnly: true
      affinity:
{{- if .Values.web.additionalAffinities }}
{{ toYaml .Values.web.additionalAffinities | indent 8 }}
{{- end }}
      volumes:
        - name: concourse-keys
          secret:
            secretName: {{ template "concourse.concourse.fullname" . }}
            defaultMode: 0400
            items:
              - key: host-key
                path: host_key
              - key: session-signing-key
                path: session_signing_key
              - key: worker-key-pub
                path: worker_key.pub
        {{- if .Values.concourse.web.vault.enabled }}
        - name: vault-keys
          secret:
            secretName: {{ template "concourse.concourse.fullname" . }}
            defaultMode: 0400
            items:
            {{- if .Values.concourse.web.vault.useCaCert }}
              - key: vault-ca-cert
                path: ca.cert
            {{- end }}
            {{- if eq (default "" .Values.concourse.web.vault.authBackend) "cert" }}
              - key: vault-client-cert
                path: client.cert
              - key: vault-client-key
                path: client.key
            {{- end }}
        {{- end }}
        {{- if not (eq (default "disable" .Values.concourse.web.postgres.sslmode) "disable") }}
        - name: postgresql-keys
          secret:
            secretName: {{ template "concourse.concourse.fullname" . }}
            defaultMode: 0400
            items:
              - key: postgresql-ca-cert
                path: ca.cert
              - key: postgresql-client-cert
                path: client.cert
              - key: postgresql-client-key
                path: client.key
        {{- end }}
        {{- if .Values.concourse.web.syslog.enabled }}
        - name: syslog-keys
          secret:
            secretName: {{ template "concourse.concourse.fullname" . }}
            defaultMode: 0400
            items:
              - key: syslog-ca-cert
                path: ca.cert
        {{- end }}
        - name: auth-keys
          secret:
            secretName: {{ template "concourse.concourse.fullname" . }}
            defaultMode: 0400
            items:
              {{- if .Values.concourse.web.auth.cf.useCaCert }}
              - key: cf-ca-cert
                path: cf_ca.cert
              {{- end }}
              {{- if .Values.concourse.web.auth.github.useCaCert }}
              - key: github-ca-cert
                path: github_ca.cert
              {{- end }}
              {{- if .Values.concourse.web.auth.ldap.useCaCert }}
              - key: ldap-ca-cert
                path: ldap_ca.cert
              {{- end }}
              {{- if .Values.concourse.web.auth.oauth.useCaCert }}
              - key: oauth-ca-cert
                path: oauth_ca.cert
              {{- end }}
              {{- if .Values.concourse.web.auth.oidc.useCaCert }}
              - key: oidc-ca-cert
                path: oidc_ca.cert
              {{- end }}
