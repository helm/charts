{{- define "container-network-tracer" -}}
- name: {{ .Chart.Name }}-network-tracer
  image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
  imagePullPolicy: {{ .Values.image.pullPolicy }}
  command: ["network-tracer", "--config=/etc/datadog-agent/network-tracer.yaml"]
  securityContext:
    capabilities:
      add: ["SYS_ADMIN", "SYS_RESOURCE"]
  resources:
{{ toYaml .Values.daemonset.containers.networkTracer.resources | indent 4 }}
  env:
    {{- include "containers-common" . | nindent 4 }}
    - name: DD_NETWORK_TRACING_ENABLED
      value: {{ .Values.datadog.networkTracerEnabled | quote }}
    - name: DD_NETTRACER_SOCKET
      value: /var/run/network/tracer.sock
{{- if .Values.daemonset.containers.networkTracer.env }}
{{ toYaml .Values.daemonset.containers.networkTracer.env | indent 4 }}
{{- end }}
  volumeMounts:
    - name: cgroups
      mountPath: /host/sys/fs/cgroup
      readOnly: true
    - name: config
      mountPath: /etc/datadog-agent
    - name: debugfs
      mountPath: /sys/kernel/debug
    - name: network-run
      mountPath: /var/run/network
    - name: procdir
      mountPath: /host/proc
      readOnly: true
  livenessProbe:
    exec:
      command: ["test", "-S", "/var/run/network/tracer.sock"]
    initialDelaySeconds: 15
    periodSeconds: 15
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 2
{{- end -}}
