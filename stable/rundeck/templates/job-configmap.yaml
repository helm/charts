apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app: {{ template "rundeck.name" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    component: "{{ template "rundeck.name" . }}"
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
  name: {{ template "rundeck.fullname" . }}-job
data:
  project.properties: |-
    #
    project.name={{ .Values.env.RD_PROJECT }}
    project.ssh-authentication=privateKey
    service.NodeExecutor.default.provider=jsch-ssh
    resources.source.1.config.includeServerNode=true
    resources.source.1.config.generateFileAutomatically=true
    resources.source.1.config.file=/rundeck/projects/{{ .Values.env.RD_PROJECT }}/etc/resources.xml
    project.ssh-keypath={{ .Values.env.RSA_KEY_DIR }}/id_rsa
    service.FileCopier.default.provider=jsch-scp
    resources.source.1.type=file
  resources.xml: |-
    <?xml version="1.0" encoding="UTF-8"?>
    <project>
      {{- range $key, $val := .Values.edgeNodes }}
      <node name="{{ $key }}" description="Hadoop Edge Node {{ $key }}" tags="" hostname="{{ $key }}" osArch="amd64" osFamily="unix" osName="Linux" osVersion="3.10.0-514.16.1.el7.x86_64" username="{{ $val }}"/>
      {{- end }}
    </project>