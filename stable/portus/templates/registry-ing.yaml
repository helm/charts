apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: "{{ template "registry.fullname" . }}"
  labels:
    heritage: {{ .Release.Service | quote }}
    release: {{ .Release.Name | quote }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    app: "{{ template "portus.fullname" . }}"
  annotations:
    kubernetes.io/tls-acme: "true"
    kubernetes.io/ingress.class: "nginx"
    # nginx config upstream requires https
    ingress.kubernetes.io/secure-backends: "true"
    # registry needs to increase proxy-body-size
    ingress.kubernetes.io/proxy-body-size: 100m
spec:
  tls:
  - hosts:
    - {{ .Values.registry.fqdn }}
    secretName: {{ .Values.registry.fqdn }}.tls
  rules:
  - host: {{ .Values.registry.fqdn }}
    http:
      paths:
      - backend:
          serviceName: {{ template "registry.fullname" . }}
          servicePort: 443
        path: /
