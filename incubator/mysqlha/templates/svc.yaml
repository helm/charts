# Client service for connecting to any MySQL instance for reads.
{{- if .Values.service.type }}
{{- $fullname := include "fullname" . }}
{{- $rc_number := int .Values.mysqlha.replicaCount }}
{{- $root := . }}
{{ range $i := until $rc_number }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ template "fullname" $root }}-svc-{{ $i }}
  labels:
    app: {{ template "fullname" $root }}
    chart: "{{ $root.Chart.Name }}-{{ $root.Chart.Version }}"
    release: "{{ $root.Release.Name }}"
    heritage: "{{ $root.Release.Service }}"
  annotations:
{{- if and ($root.Values.service.type) ($root.Values.service.annotations) }}
{{ toYaml $root.Values.service.annotations | indent 4 }}
{{- end }}
{{- if and ($root.Values.metrics.enabled) ($root.Values.metrics.annotations) }}
{{ toYaml $root.Values.metrics.annotations | indent 4 }}
{{- end }}
spec:
  type: {{ $root.Values.service.type }}
  ports:
  - name: mysql
    port: 3306
    protocol: TCP
    targetPort: mysql
{{- if $root.Values.metrics.enabled }}
  - name: metrics
    port: 9104
    protocol: TCP
    targetPort: metrics
{{- end }}
  selector:
    app: {{ template "fullname" $root }}
    statefulset.kubernetes.io/pod-name: {{ template "fullname" $root }}-{{ $i }}
{{- end }}
{{- end }}