apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ template "fullname" . }}-certs"
  labels:
    heritage: {{.Release.Service | quote }}
    release: {{.Release.Name | quote }}
    chart: "{{.Chart.Name}}-{{.Chart.Version}}"
    component: "{{.Release.Name}}-certs"
spec:
  completions: 1
  parallelism: 1
  template:
    metadata:
      name: {{.Release.Name}}-certs
      labels:
        heritage: {{.Release.Service | quote }}
        release: {{.Release.Name | quote }}
        chart: "{{.Chart.Name}}-{{.Chart.Version}}"
        component: "{{.Release.Name}}-postinstall"
    spec:
     restartPolicy: "Never"
     containers:
      - name: "{{ template "fullname" . }}-postinstall"
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}" 
        command: 
          - "/bin/bash"
          - "-cx"
          - |
            
            #init PKI
            /usr/share/doc/openvpn 
            . ./vars
            ./clean-all
            ./build-ca

            #Generate certificate & key for server
            ./build-key-server {{template "fullname" . }}
            
            #Generate Diffie Hellman parameters
            ./build-dh
            
            #restart the openvpn pods
            SERVICE_NAME='{{template "fullname" . }}'
            kubectl scale deployment/${SERVICE_NAME} --replicas=0; 
            kubectl scale deployment/${SERVICE_NAME} --replicas=1;
 
